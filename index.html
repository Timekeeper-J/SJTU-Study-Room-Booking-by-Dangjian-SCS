<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»„ç»‡éƒ¨è‡ªä¹ å®¤é¢„çº¦</title>
    
    <!-- æ ¸å¿ƒåº“ (JSDelivr æºï¼Œç¨³å®š) -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        .card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 16px; 
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.05); 
            transition: all 0.3s ease; 
        }
        .card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.15); 
            border-color: rgba(99, 102, 241, 0.2);
        }

        .btn-primary { background: #4f46e5; color: white; transition: all 0.2s; }
        .btn-primary:hover { background: #4338ca; shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .btn-primary:active { transform: scale(0.96); }

        .btn-ghost { background: #f1f5f9; color: #64748b; border: 1px dashed #cbd5e1; transition: all 0.2s; }
        .btn-ghost:hover { border-color: #4f46e5; color: #4f46e5; background: #eef2ff; }

        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f8fafc; z-index: 999; display: flex;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .loader {
            width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #4f46e5; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="loading-mask">
        <div class="loader"></div>
        <p class="mt-4 text-slate-500 text-sm font-medium">æ­£åœ¨åŒæ­¥é¢„çº¦æ•°æ®...</p>
    </div>

    <div id="app" class="max-w-[90rem] mx-auto p-4 md:p-8 pb-24" style="display:none;" v-cloak>
        <!-- å¤´éƒ¨ -->
        <header class="mb-10 flex flex-col md:flex-row justify-between items-end gap-6 border-b border-slate-200 pb-6">
            <div>
                <div class="flex items-center gap-3">
                    <span class="text-4xl">ğŸ“…</span>
                    <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">ç»„ç»‡éƒ¨æœŸæœ«å‘¨è‡ªä¹ å®¤é¢„çº¦å¹³å°</h1>
                </div>
                <p class="text-slate-500 text-sm mt-2 font-medium pl-1">
                    ä½ å¥½ï¼Œ<span class="text-indigo-600 font-bold">${ currentUser || 'åŒå­¦' }</span> 
                    <span v-if="!currentUser"> Â· è¯·å…ˆéªŒè¯èº«ä»½</span>
                </p>
            </div>
            
            <!-- ç™»å½•æ¡†ä¿®æ”¹ï¼šå¢åŠ å­¦å·è¾“å…¥ -->
            <div v-if="!currentUser" class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center bg-white p-3 rounded-xl shadow-sm border border-slate-100 w-full md:w-auto">
                <input v-model="tempName" type="text" placeholder="å§“å (å¦‚: å¼ ä¸‰)" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none w-full sm:w-32">
                <input v-model="tempId" @keyup.enter="login" type="text" placeholder="å­¦å· (å¦‚: 5210...)" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none w-full sm:w-40">
                <button @click="login" class="btn-primary px-4 py-2 rounded-lg text-sm font-bold shadow-md whitespace-nowrap">éªŒè¯è¿›å…¥</button>
            </div>
            <div v-else>
                <button @click="logout" class="text-slate-400 text-xs hover:text-indigo-500 transition-colors font-medium">
                    åˆ‡æ¢è´¦å· &rarr;
                </button>
            </div>
        </header>

        <!-- ä¸»å†…å®¹ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <div v-for="day in days" :key="day.dateStr" class="card flex flex-col h-full relative group">
                <!-- æ—¥æœŸ -->
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 rounded-t-xl flex justify-between items-center">
                    <div>
                        <span class="text-lg font-bold text-slate-800">${ formatDate(day.dateStr).split(' ')[0] }</span>
                        <span class="text-xs font-bold ml-2 px-2 py-0.5 rounded text-slate-500 bg-slate-200">${ formatDate(day.dateStr).split(' ')[1] }</span>
                    </div>
                </div>
                
                <div class="p-4 space-y-4 flex-1">
                    <div v-for="(slot, slotId) in day.slots" :key="slotId" class="relative pl-3 border-l-2" :class="getSlotBorderColor(slot)">
                        <!-- æ—¶æ®µå¤´ -->
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-sm font-bold text-slate-700">${ slot.label }</h3>
                            <span :class="getStatusBadgeClass(slot)" class="text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider">
                                ${ getStatusText(slot) }
                            </span>
                        </div>

                        <!-- é¢„çº¦äººåŒº -->
                        <div class="mb-2">
                            <div v-if="slot.booker" class="flex justify-between items-center bg-indigo-50/80 text-indigo-900 px-3 py-2 rounded-lg text-sm border border-indigo-100 shadow-sm">
                                <div class="flex items-center gap-2 overflow-hidden">
                                    <span class="w-2 h-2 rounded-full bg-indigo-500 flex-shrink-0"></span>
                                    <span class="font-bold truncate text-xs" :title="slot.booker">${ slot.booker }</span>
                                </div>
                                <span v-if="slot.booker === currentUser" class="text-xs text-red-500 hover:bg-red-50 p-1 rounded cursor-pointer font-bold shrink-0" @click="cancelBooking(day, slot, 'booker')">å–æ¶ˆ</span>
                            </div>
                            <button v-else @click="bookAsMain(day, slot)" :disabled="slot.booker" class="w-full py-2 rounded-lg text-xs font-bold btn-ghost flex justify-center items-center gap-1">
                                <span class="text-lg leading-none">+</span> è®¤é¢†é¢„çº¦äºº
                            </button>
                        </div>
                        
                        <!-- éšè¡ŒåŒº -->
                        <div>
                            <div v-if="slot.followers && slot.followers.length > 0" class="flex flex-wrap gap-2 mb-2">
                                <span v-for="f in slot.followers" :key="f" class="bg-slate-100 border border-slate-200 px-2 py-0.5 rounded text-xs text-slate-600 flex items-center gap-1 font-medium">
                                    ${ f }
                                    <span v-if="f === currentUser" class="text-red-400 hover:text-red-600 cursor-pointer text-sm leading-none ml-0.5" @click="cancelBooking(day, slot, 'follower')">&times;</span>
                                </span>
                            </div>
                            
                            <button v-if="shouldShowFollowerBtn(slot)" 
                                    @click="bookAsFollower(day, slot)" 
                                    :disabled="isAlreadyFollower(slot)"
                                    class="w-full py-1.5 rounded border border-transparent text-slate-400 text-xs hover:text-indigo-600 hover:bg-indigo-50 transition-all font-medium flex items-center justify-center gap-1">
                                ${ getFollowerBtnText(slot) }
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-16 border-t border-slate-200 pt-8 text-center">
            <p class="text-slate-400 text-xs font-medium tracking-wide">
                ä¸Šæµ·äº¤é€šå¤§å­¦è®¡ç®—æœºå­¦é™¢å…šå»ºç ”ç©¶ä¼šç»„ç»‡éƒ¨ Â· Code by Yishu
            </p>
        </div>
    </div>

    <script>
        // --- âš ï¸ å¿…å¡«ï¼šä½ çš„ AppID å’Œ Key ---
        const APP_ID = 'MpWMjFVRc0H3Y5BAQuUk0DN7-gzGzoHsz'; 
        const APP_KEY = '6VXWHUYqbTjNVtqqnhmoJOzN';
        const SERVER_URL = 'https://avoscloud.com';
        // --------------------------------

        setTimeout(() => { if (typeof AV === 'undefined') alert("åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚"); }, 5000);
        const { createApp, ref, onMounted } = Vue;
        if (typeof AV !== 'undefined') { AV.init({ appId: APP_ID, appKey: APP_KEY, serverURLs: SERVER_URL }); }

        const app = createApp({
            compilerOptions: { delimiters: ['${', '}'] },
            setup() {
                const days = ref([]);
                // ä¿®æ”¹ Key å¼ºåˆ¶æ—§ç”¨æˆ·ç™»å‡º
                const currentUser = ref(localStorage.getItem('sjtu_user_v2') || '');
                const tempName = ref('');
                const tempId = ref(''); // æ–°å¢å­¦å·

                const initDays = () => {
                    const arr = [];
                    for(let i=0; i<8; i++) {
                        const d = new Date();
                        d.setDate(d.getDate() + i);
                        const dateStr = d.toISOString().split('T')[0];
                        arr.push({ 
                            dateStr, 
                            slots: {
                                s1: { id: 's1', label: '09:00 - 13:00', booker: null, followers: [] },
                                s2: { id: 's2', label: '14:00 - 18:00', booker: null, followers: [] },
                                s3: { id: 's3', label: '19:00 - 22:30', booker: null, followers: [] }
                            }
                        });
                    }
                    days.value = arr;
                };

                const fetchData = async () => {
                    if (typeof AV === 'undefined') return;
                    try {
                        const query = new AV.Query('Booking');
                        query.greaterThanOrEqualTo('date', days.value[0].dateStr);
                        const results = await query.find();
                        results.forEach(record => {
                            const data = record.toJSON();
                            const targetDay = days.value.find(d => d.dateStr === data.date);
                            if(targetDay && data.slots) {
                                targetDay.id = record.objectId;
                                if(data.slots.s1) Object.assign(targetDay.slots.s1, data.slots.s1);
                                if(data.slots.s2) Object.assign(targetDay.slots.s2, data.slots.s2);
                                if(data.slots.s3) Object.assign(targetDay.slots.s3, data.slots.s3);
                            }
                        });
                    } catch(e) { console.error(e); } 
                    finally { 
                        document.getElementById('loading-mask').style.display = 'none';
                        document.getElementById('app').style.display = 'block';
                    }
                };

                // --- ç™»å½•é€»è¾‘å‡çº§ ---
                const login = () => {
                    if(!tempName.value) return alert('è¯·è¾“å…¥å§“å');
                    if(!tempId.value || tempId.value.length < 4) return alert('è¯·è¾“å…¥æ­£ç¡®çš„å­¦å·');
                    
                    // è‡ªåŠ¨æˆªå–åå››ä½
                    const last4 = tempId.value.slice(-4);
                    // ç»„åˆæˆæ˜¾ç¤ºæ ¼å¼ï¼šå¼ ä¸‰ (1234)
                    const finalName = `${tempName.value} (${last4})`;
                    
                    currentUser.value = finalName;
                    localStorage.setItem('sjtu_user_v2', finalName);
                };
                
                const logout = () => { localStorage.removeItem('sjtu_user_v2'); location.reload(); };

                // è¾…åŠ©å‡½æ•°ä¿æŒä¸å˜
                const getSlotBorderColor = (slot) => {
                    if (slot.booker) return 'border-indigo-500';
                    if (slot.followers.length > 0) return 'border-orange-400';
                    return 'border-slate-200';
                };
                const getStatusBadgeClass = (slot) => {
                    const status = getStatusText(slot);
                    if (status === 'å·²æ»¡') return 'bg-red-100 text-red-600';
                    if (status === 'ç¼ºé¢„çº¦äºº') return 'bg-orange-100 text-orange-600';
                    if (status === 'ç©ºé—²') return 'bg-slate-100 text-slate-400';
                    return 'bg-emerald-100 text-emerald-600';
                };
                const shouldShowFollowerBtn = (slot) => !slot.followers || slot.followers.length < 2;
                const isAlreadyFollower = (slot) => slot.followers && slot.followers.includes(currentUser.value);
                const getFollowerBtnText = (slot) => {
                    if (slot.followers && slot.followers.includes(currentUser.value)) return `å·²åŠ å…¥`;
                    const count = slot.followers ? slot.followers.length : 0;
                    return count === 0 ? '+ åŠ å…¥éšè¡Œ' : `+ åŠ å…¥éšè¡Œ (${count}/2)`;
                };

                const bookAsMain = async (day, slot) => {
                    if(!currentUser.value) return alert('è¯·å…ˆéªŒè¯èº«ä»½');
                    const { s1, s2, s3 } = day.slots;
                    if (slot.id === 's1' && s2.booker === currentUser.value) return alert('ä¸èƒ½è¿ç»­é¢„çº¦ä¸Šåˆå’Œä¸‹åˆï¼');
                    if (slot.id === 's2' && (s1.booker === currentUser.value || s3.booker === currentUser.value)) return alert('ä¸èƒ½è¿ç»­é¢„çº¦ç›¸é‚»æ—¶æ®µï¼');
                    if (slot.id === 's3' && s2.booker === currentUser.value) return alert('ä¸èƒ½è¿ç»­é¢„çº¦ä¸‹åˆå’Œæ™šä¸Šï¼');

                    if(slot.followers.includes(currentUser.value)) slot.followers = slot.followers.filter(n => n !== currentUser.value);
                    slot.booker = currentUser.value;
                    saveToCloud(day);
                };

                const bookAsFollower = (day, slot) => {
                    if(!currentUser.value) return alert('è¯·å…ˆéªŒè¯èº«ä»½');
                    if(slot.booker === currentUser.value) return alert('ä½ å·²ç»æ˜¯è¯¥æ—¶æ®µé¢„çº¦äººäº†');
                    if(slot.followers.includes(currentUser.value)) return;
                    slot.followers.push(currentUser.value);
                    saveToCloud(day);
                };

                const cancelBooking = (day, slot, role) => {
                    if(!confirm('ç¡®å®šå–æ¶ˆå—ï¼Ÿ')) return;
                    if(role === 'booker') slot.booker = null;
                    else slot.followers = slot.followers.filter(n => n !== currentUser.value);
                    saveToCloud(day);
                };

                const saveToCloud = async (day) => {
                    if (typeof AV === 'undefined') return alert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•ä¿å­˜');
                    try {
                        const cleanSlots = JSON.parse(JSON.stringify(day.slots));
                        if(day.id) {
                            const todo = AV.Object.createWithoutData('Booking', day.id);
                            todo.set('slots', cleanSlots);
                            await todo.save();
                        } else {
                            const Booking = AV.Object.extend('Booking');
                            const booking = new Booking();
                            booking.set('date', day.dateStr);
                            booking.set('slots', cleanSlots);
                            const res = await booking.save();
                            day.id = res.objectId;
                        }
                    } catch (error) { console.error(error); alert('ä¿å­˜å¤±è´¥'); fetchData(); }
                };
                
                const formatDate = (str) => {
                    const d = new Date(str);
                    const week = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
                    return `${d.getMonth()+1}.${d.getDate()} ${week[d.getDay()]}`;
                };
                
                const getStatusText = (slot) => {
                    const isFull = slot.followers && slot.followers.length >= 2;
                    if (slot.booker && isFull) return 'å·²æ»¡';
                    if (!slot.booker && (!slot.followers || slot.followers.length === 0)) return 'ç©ºé—²';
                    if (!slot.booker && slot.followers.length > 0) return 'ç¼ºé¢„çº¦äºº';
                    return 'å¯åŠ å…¥';
                };

                onMounted(() => { initDays(); fetchData(); });

                return { days, currentUser, tempName, tempId, login, logout, bookAsMain, bookAsFollower, cancelBooking, formatDate, getStatusText, shouldShowFollowerBtn, getFollowerBtnText, isAlreadyFollower, getSlotBorderColor, getStatusBadgeClass };
            }
        });
        
        app.mount('#app');
    </script>
</body>
</html>
