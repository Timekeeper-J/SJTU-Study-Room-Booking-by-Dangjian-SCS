<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»„ç»‡éƒ¨è‡ªä¹ å®¤é¢„çº¦</title>
    
    <!-- 1. æ¢ç”¨é˜¿é‡Œé¥¿äº†ä¹ˆ CDN (npm.elemecdn.com) -->
    <!-- è¿™æ˜¯å›½å†…ç›®å‰æœ€å¯é çš„ NPM é•œåƒæºï¼Œä¸“æ²»å„ç§ 404 å’Œ JSON æŠ¥é”™ -->
    <script src="https://npm.elemecdn.com/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://npm.elemecdn.com/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <!-- Tailwind è¿˜æ˜¯ç”¨å®˜æ–¹çš„ï¼Œå¦‚æœè¿™ä¸ªåŠ è½½å¤±è´¥ï¼Œç½‘é¡µä¼šå˜ä¸‘ä½†èƒ½ç”¨ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #F2F2F7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .btn { transition: all 0.2s; }
        .btn:active { transform: scale(0.95); }
        
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #F2F2F7; z-index: 999; display: flex;
            justify-content: center; align-items: center; color: #666; flex-direction: column;
        }
        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="loading-mask">
        <h2 style="font-size:20px; font-weight:bold;">æ­£åœ¨åŠ è½½æ•°æ®åº“...</h2>
        <p style="font-size:12px; margin-top:10px; color:#999">å¦‚é•¿æ—¶é—´å¡ä½ï¼Œè¯·å°è¯•åˆ‡æ¢ç½‘ç»œï¼ˆå…³é—­ä»£ç†ï¼‰</p>
    </div>

    <div id="app" class="max-w-7xl mx-auto p-6 pb-20" style="display:none;" v-cloak>
        <header class="mb-8 mt-2 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">è‡ªä¹ å®¤é¢„çº¦ ğŸ“…</h1>
                <p class="text-gray-500 text-sm mt-1">ä½ å¥½ï¼Œ${ currentUser || 'æœªè®¾ç½®å§“å' }</p>
            </div>
            <div v-if="!currentUser" class="bg-blue-50 border border-blue-100 p-3 rounded-lg flex gap-2 items-center">
                <input v-model="tempName" @keyup.enter="login" type="text" placeholder="è¾“å…¥å§“å..." class="border p-1.5 rounded text-sm w-32">
                <button @click="login" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm font-medium btn">ç¡®å®š</button>
            </div>
            <div v-else><button @click="logout" class="text-gray-400 text-xs hover:text-gray-600 underline">åˆ‡æ¢è´¦å·</button></div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
            <div v-for="day in days" :key="day.dateStr" class="card p-5 relative overflow-hidden flex flex-col h-full border border-gray-100">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-3 text-center">${ formatDate(day.dateStr) }</h2>
                
                <div class="flex-1 space-y-4">
                    <div v-for="(slot, slotId) in day.slots" :key="slotId" class="p-3 rounded-lg bg-gray-50/50">
                        <div class="flex justify-between items-baseline mb-3">
                            <h3 class="font-bold text-gray-700">${ slot.label }</h3>
                            <span :class="getStatusColor(slot)" class="text-xs font-bold px-2 py-1 rounded-full bg-opacity-20 whitespace-nowrap">${ getStatusText(slot) }</span>
                        </div>

                        <div class="mb-3">
                            <div v-if="slot.booker" class="flex justify-between items-center bg-blue-50 text-blue-900 px-3 py-2 rounded-lg font-medium text-sm">
                                <span><span class="text-xs mr-1 opacity-60">é¢„çº¦:</span> ${ slot.booker }</span>
                                <span v-if="slot.booker === currentUser" class="text-xs text-red-500 cursor-pointer hover:bg-red-50 p-1 rounded" @click="cancelBooking(day, slot, 'booker')">å–æ¶ˆ</span>
                            </div>
                            <button v-else @click="bookAsMain(day, slot)" :disabled="slot.booker" class="w-full py-1.5 border-2 border-dashed border-gray-300 text-gray-400 rounded-lg hover:border-blue-400 hover:text-blue-500 btn text-xs">
                                + è®¤é¢†é¢„çº¦äºº
                            </button>
                        </div>
                        
                        <div>
                            <div class="flex flex-wrap gap-2 min-h-[28px]">
                                <span v-for="f in slot.followers" :key="f" class="bg-gray-200 px-2 py-0.5 rounded text-xs text-gray-700 flex items-center gap-1">
                                    ${ f }
                                    <span v-if="f === currentUser" class="text-red-400 cursor-pointer" @click="cancelBooking(day, slot, 'follower')">Ã—</span>
                                </span>
                            </div>
                            <button v-if="shouldShowFollowerBtn(slot)" 
                                    @click="bookAsFollower(day, slot)" 
                                    :disabled="isAlreadyFollower(slot)"
                                    class="w-full mt-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-500 text-xs rounded border btn">
                                ${ getFollowerBtnText(slot) }
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-12 text-center text-gray-400 text-xs pb-10">ä¸Šæµ·äº¤å¤§è®¡ç®—æœºå­¦é™¢å…šå»ºç ”ç©¶ä¼šç»„ç»‡éƒ¨</div>
    </div>

    <script>
        // å…œåº•é”™è¯¯å¤„ç†ï¼šå¦‚æœCDNçœŸçš„å…¨æŒ‚äº†ï¼Œåœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå¤§çº¢å­—ï¼Œè€Œä¸æ˜¯ä¸€ç‰‡ç™½
        window.onerror = function(msg, url, line) { 
            console.error('Global Error:', msg); 
            if(msg.includes('Vue') || msg.includes('AV')) {
                document.getElementById('loading-mask').innerHTML = 
                    '<h2 style="color:red;padding:20px;text-align:center">CDN èµ„æºåŠ è½½å¤±è´¥</h2>' +
                    '<p style="text-align:center">è¯·æ£€æŸ¥ç½‘ç»œï¼Œæˆ–å°è¯•ä½¿ç”¨æ‰‹æœºçƒ­ç‚¹ã€‚</p>';
            }
            return false; 
        };

        // --- âš ï¸ åˆ«å¿˜äº†æŠŠä½ çš„ AppID å’Œ Key å¡«å›æ¥ï¼---
        const APP_ID = 'MpWMjFVRc0H3Y5BAQuUk0DN7-gzGzoHsz'; 
        const APP_KEY = '6VXWHUYqbTjNVtqqnhmoJOzN';
        const SERVER_URL = 'https://avoscloud.com';
        // ------------------------------------------

        // æ£€æµ‹ Vue æ˜¯å¦åŠ è½½æˆåŠŸ
        if (typeof Vue === 'undefined') {
            throw new Error('Vue load failed');
        }

        const { createApp, ref, onMounted } = Vue;
        
        if (typeof AV !== 'undefined') {
            AV.init({ appId: APP_ID, appKey: APP_KEY, serverURLs: SERVER_URL });
        } else {
            console.error("LeanCloud SDK load failed");
        }

        const app = createApp({
            compilerOptions: { delimiters: ['${', '}'] },
            setup() {
                const days = ref([]);
                const currentUser = ref(localStorage.getItem('sjtu_user') || '');
                const tempName = ref('');

                const initDays = () => {
                    const arr = [];
                    for(let i=0; i<7; i++) {
                        const d = new Date();
                        d.setDate(d.getDate() + i);
                        const dateStr = d.toISOString().split('T')[0];
                        arr.push({ 
                            dateStr, 
                            slots: {
                                s1: { id: 's1', label: '9:00 - 13:00', booker: null, followers: [] },
                                s2: { id: 's2', label: '14:00 - 18:00', booker: null, followers: [] },
                                s3: { id: 's3', label: '19:00 - 22:30', booker: null, followers: [] }
                            }
                        });
                    }
                    days.value = arr;
                };

                const fetchData = async () => {
                    try {
                        const query = new AV.Query('Booking');
                        query.greaterThanOrEqualTo('date', days.value[0].dateStr);
                        const results = await query.find();
                        
                        results.forEach(record => {
                            const data = record.toJSON();
                            const targetDay = days.value.find(d => d.dateStr === data.date);
                            if(targetDay && data.slots) {
                                targetDay.id = record.objectId;
                                // å®‰å…¨åˆå¹¶æ•°æ®
                                if(data.slots.s1) Object.assign(targetDay.slots.s1, data.slots.s1);
                                if(data.slots.s2) Object.assign(targetDay.slots.s2, data.slots.s2);
                                if(data.slots.s3) Object.assign(targetDay.slots.s3, data.slots.s3);
                            }
                        });
                    } catch(e) {
                        console.error("Fetch Data Error:", e);
                    } finally {
                        // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½éšè—åŠ è½½åŠ¨ç”»ï¼Œé˜²æ­¢å¡æ­»
                        const mask = document.getElementById('loading-mask');
                        if(mask) mask.style.display = 'none';
                        document.getElementById('app').style.display = 'block';
                    }
                };

                const login = () => {
                    if(!tempName.value) return alert('è¯·è¾“å…¥å§“å');
                    currentUser.value = tempName.value;
                    localStorage.setItem('sjtu_user', tempName.value);
                };
                const logout = () => {
                    localStorage.removeItem('sjtu_user');
                    location.reload();
                };

                // UI è¾…åŠ©é€»è¾‘
                const shouldShowFollowerBtn = (slot) => !slot.followers || slot.followers.length < 3;
                const isAlreadyFollower = (slot) => slot.followers && slot.followers.includes(currentUser.value);
                const getFollowerBtnText = (slot) => {
                    if (slot.followers && slot.followers.includes(currentUser.value)) {
                        return `å·²åŠ å…¥ (${slot.followers.length}/3)`;
                    }
                    return `+ åŠ å…¥éšè¡Œ (${slot.followers ? slot.followers.length : 0}/3)`;
                };

                const bookAsMain = async (day, slot) => {
                    if(!currentUser.value) return alert('è¯·å…ˆè®¾ç½®å§“å');

                    const { s1, s2, s3 } = day.slots;
                    if (slot.id === 's1' && s2.booker === currentUser.value) return alert('ä¸èƒ½è¿ç»­é¢„çº¦ä¸Šåˆå’Œä¸‹åˆä¸¤ä¸ªæ—¶æ®µå“¦ï¼');
                    if (slot.id === 's2' && (s1.booker === currentUser.value || s3.booker === currentUser.value)) return alert('ä¸èƒ½è¿ç»­é¢„çº¦ç›¸é‚»çš„ä¸¤ä¸ªæ—¶æ®µå“¦ï¼');
                    if (slot.id === 's3' && s2.booker === currentUser.value) return alert('ä¸èƒ½è¿ç»­é¢„çº¦ä¸‹åˆå’Œæ™šä¸Šä¸¤ä¸ªæ—¶æ®µå“¦ï¼');

                    if(slot.followers.includes(currentUser.value)) {
                        slot.followers = slot.followers.filter(n => n !== currentUser.value);
                    }
                    slot.booker = currentUser.value;
                    saveToCloud(day);
                };

                const bookAsFollower = (day, slot) => {
                    if(!currentUser.value) return alert('è¯·å…ˆè®¾ç½®å§“å');
                    if(slot.booker === currentUser.value) return alert('ä½ å·²ç»æ˜¯è¯¥æ—¶æ®µçš„é¢„çº¦äººäº†');
                    if(slot.followers.includes(currentUser.value)) return;
                    
                    slot.followers.push(currentUser.value);
                    saveToCloud(day);
                };

                const cancelBooking = (day, slot, role) => {
                    if(!confirm('ç¡®å®šè¦å–æ¶ˆå—ï¼Ÿ')) return;
                    if(role === 'booker') {
                        slot.booker = null;
                    } else {
                        slot.followers = slot.followers.filter(n => n !== currentUser.value);
                    }
                    saveToCloud(day);
                };

                const saveToCloud = async (day) => {
                    try {
                        // ä½¿ç”¨ JSON æ·±æ‹·è´å»é™¤ Vue çš„ Proxy ä»£ç†ï¼Œé˜²æ­¢ LeanCloud æŠ¥é”™
                        const cleanSlots = JSON.parse(JSON.stringify(day.slots));
                        
                        if(day.id) {
                            const todo = AV.Object.createWithoutData('Booking', day.id);
                            todo.set('slots', cleanSlots);
                            await todo.save();
                        } else {
                            const Booking = AV.Object.extend('Booking');
                            const booking = new Booking();
                            booking.set('date', day.dateStr);
                            booking.set('slots', cleanSlots);
                            const res = await booking.save();
                            day.id = res.objectId;
                        }
                    } catch (error) {
                        console.error(error);
                        alert('ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½ç½‘ç»œä¸ç¨³å®šï¼Œè¯·åˆ·æ–°é‡è¯•');
                        fetchData();
                    }
                };
                
                const formatDate = (str) => {
                    const d = new Date(str);
                    const week = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                    return `${d.getMonth()+1}.${d.getDate()} å‘¨${week[d.getDay()]}`;
                };
                
                const getStatusText = (slot) => {
                    const isFull = slot.followers && slot.followers.length >= 3;
                    if (slot.booker && isFull) return 'å·²æ»¡å‘˜';
                    if (!slot.booker && (!slot.followers || slot.followers.length === 0)) return 'ç©ºé—²';
                    if (!slot.booker && slot.followers.length > 0) return 'ç¼ºé¢„çº¦äºº';
                    return 'å¯åŠ å…¥';
                };
                
                const getStatusColor = (slot) => {
                    const status = getStatusText(slot);
                    if (status === 'å·²æ»¡å‘˜') return 'bg-red-100 text-red-700';
                    if (status === 'ç©ºé—²') return 'bg-green-100 text-green-700';
                    if (status === 'ç¼ºé¢„çº¦äºº') return 'bg-orange-100 text-orange-700';
                    return 'bg-blue-100 text-blue-700';
                };

                onMounted(() => {
                    initDays();
                    fetchData();
                });

                return { days, currentUser, tempName, login, logout, bookAsMain, bookAsFollower, cancelBooking, formatDate, getStatusText, getStatusColor, shouldShowFollowerBtn, getFollowerBtnText, isAlreadyFollower };
            }
        });
        
        app.mount('#app');
    </script>
</body>
</html>
