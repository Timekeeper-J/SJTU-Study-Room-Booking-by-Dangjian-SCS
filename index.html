<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁªÑÁªáÈÉ®Ëá™‰π†ÂÆ§È¢ÑÁ∫¶</title>
    
    <!-- 1. Ê†∏ÂøÉÂ∫ìÊç¢Áî® BootCDN (ÂõΩÂÜÖÊúÄÁ®≥Ôºå‰øÆÂ§ç 404 ÈóÆÈ¢ò) -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/leancloud-storage/4.15.0/av-min.js"></script>
    
    <!-- 2. UIÂ∫ì‰ΩøÁî®ÂÆòÊñπÊ∫ê (Á°Æ‰øùÊñá‰ª∂Â≠òÂú®) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #F2F2F7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .btn { transition: all 0.2s; }
        .btn:active { transform: scale(0.95); }
        
        /* Âä†ËΩΩÂä®Áîª */
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #F2F2F7; z-index: 999; display: flex;
            justify-content: center; align-items: center; color: #666;
        }
        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="loading-mask"><h2 style="font-size:20px; font-weight:bold;">Ê≠£Âú®Âä†ËΩΩ...</h2></div>

    <div id="app" class="max-w-7xl mx-auto p-6 pb-20" style="display:none;" v-cloak>
        <header class="mb-8 mt-2 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Ëá™‰π†ÂÆ§È¢ÑÁ∫¶ üìÖ</h1>
                <p class="text-gray-500 text-sm mt-1">‰Ω†Â•ΩÔºå${ currentUser || 'Êú™ËÆæÁΩÆÂßìÂêç' }</p>
            </div>
            <div v-if="!currentUser" class="bg-blue-50 border border-blue-100 p-3 rounded-lg flex gap-2 items-center">
                <input v-model="tempName" @keyup.enter="login" type="text" placeholder="ËæìÂÖ•ÂßìÂêç..." class="border p-1.5 rounded text-sm w-32">
                <button @click="login" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm font-medium btn">Á°ÆÂÆö</button>
            </div>
            <div v-else><button @click="logout" class="text-gray-400 text-xs hover:text-gray-600 underline">ÂàáÊç¢Ë¥¶Âè∑</button></div>
        </header>

        <!-- ‰∏ªÂ∏ÉÂ±ÄÔºöÁΩëÊ†º -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
            <!-- ÊØèÂ§©‰∏Ä‰∏™Â§ßÂç°Áâá -->
            <div v-for="day in days" :key="day.dateStr" class="card p-5 relative overflow-hidden flex flex-col h-full border border-gray-100">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-3 text-center">${ formatDate(day.dateStr) }</h2>
                
                <!-- Âç°ÁâáÂÜÖÈÉ®ÂàÜ‰∏∫‰∏â‰∏™Êó∂ÊÆµ -->
                <div class="flex-1 space-y-4">
                    <div v-for="(slot, slotId) in day.slots" :key="slotId" class="p-3 rounded-lg bg-gray-50/50">
                        <!-- Êó∂ÊÆµÊ†áÈ¢ò -->
                        <div class="flex justify-between items-baseline mb-3">
                            <h3 class="font-bold text-gray-700">${ slot.label }</h3>
                            <span :class="getStatusColor(slot)" class="text-xs font-bold px-2 py-1 rounded-full bg-opacity-20 whitespace-nowrap">${ getStatusText(slot) }</span>
                        </div>

                        <!-- È¢ÑÁ∫¶‰∫∫Ê®°Âùó -->
                        <div class="mb-3">
                            <div v-if="slot.booker" class="flex justify-between items-center bg-blue-50 text-blue-900 px-3 py-2 rounded-lg font-medium text-sm">
                                <span><span class="text-xs mr-1 opacity-60">È¢ÑÁ∫¶:</span> ${ slot.booker }</span>
                                <span v-if="slot.booker === currentUser" class="text-xs text-red-500 cursor-pointer hover:bg-red-50 p-1 rounded" @click="cancelBooking(day, slot, 'booker')">ÂèñÊ∂à</span>
                            </div>
                            <button v-else @click="bookAsMain(day, slot)" :disabled="slot.booker" class="w-full py-1.5 border-2 border-dashed border-gray-300 text-gray-400 rounded-lg hover:border-blue-400 hover:text-blue-500 btn text-xs">
                                + ËÆ§È¢ÜÈ¢ÑÁ∫¶‰∫∫
                            </button>
                        </div>
                        
                        <!-- ÈöèË°å‰∫∫Ê®°Âùó -->
                        <div>
                            <div class="flex flex-wrap gap-2 min-h-[28px]">
                                <span v-for="f in slot.followers" :key="f" class="bg-gray-200 px-2 py-0.5 rounded text-xs text-gray-700 flex items-center gap-1">
                                    ${ f }
                                    <span v-if="f === currentUser" class="text-red-400 cursor-pointer" @click="cancelBooking(day, slot, 'follower')">√ó</span>
                                </span>
                            </div>
                             <button v-if="!slot.followers || slot.followers.length < 3" 
                                    @click="bookAsFollower(day, slot)" 
                                    :disabled="slot.followers && slot.followers.includes(currentUser)"
                                    class="w-full mt-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-500 text-xs rounded border btn">
                                ${ (slot.followers && slot.followers.includes(currentUser)) ? `Â∑≤Âä†ÂÖ• (${slot.followers.length}/3)` : `+ Âä†ÂÖ•ÈöèË°å (${slot.followers ? slot.followers.length : 0}/3)` }
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-12 text-center text-gray-400 text-xs pb-10">‰∏äÊµ∑‰∫§Â§ßËÆ°ÁÆóÊú∫Â≠¶Èô¢ÂÖöÂª∫Á†îÁ©∂‰ºöÁªÑÁªáÈÉ®</div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        // --- ‚ö†Ô∏è Âà´Âøò‰∫ÜÂ°´Âõû‰Ω†ÁöÑ ID Âíå Key ---
        const APP_ID = 'MpWMjFVRc0H3Y5BAQuUk0DN7-gzGzoHsz'; 
        const APP_KEY = '6VXWHUYqbTjNVtqqnhmoJOzN';
        const SERVER_URL = 'https://avoscloud.com';
        // -------------------------

        // ÈîôËØØÊçïÊçâ
        window.onerror = function(msg) { console.error('Global Error:', msg); return false; };

        // Ê£ÄÊü•Â∫ìÊòØÂê¶Âä†ËΩΩÊàêÂäü
        if (typeof AV === 'undefined' || typeof Vue === 'undefined') {
            alert('Á≥ªÁªüÂä†ËΩΩÁºìÊÖ¢ÊàñÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÔºàÂª∫ËÆÆÂÖ≥Èó≠‰ª£ÁêÜÊàñVPNÔºâÂêéÂà∑Êñ∞È°µÈù¢„ÄÇ');
        } else {
            AV.init({ appId: APP_ID, appKey: APP_KEY, serverURLs: SERVER_URL });
        }

        const app = createApp({
            compilerOptions: { delimiters: ['${', '}'] },
            setup() {
                const days = ref([]);
                const currentUser = ref(localStorage.getItem('sjtu_user') || '');
                const tempName = ref('');

                const initDays = () => {
                    const arr = [];
                    for(let i=0; i<7; i++) {
                        const d = new Date();
                        d.setDate(d.getDate() + i);
                        const dateStr = d.toISOString().split('T')[0];
                        arr.push({ 
                            dateStr, 
                            slots: {
                                s1: { id: 's1', label: '9:00 - 13:00', booker: null, followers: [] },
                                s2: { id: 's2', label: '14:00 - 18:00', booker: null, followers: [] },
                                s3: { id: 's3', label: '19:00 - 22:30', booker: null, followers: [] }
                            }
                        });
                    }
                    days.value = arr;
                };

                const fetchData = async () => {
                    try {
                        const query = new AV.Query('Booking');
                        query.greaterThanOrEqualTo('date', days.value[0].dateStr);
                        const results = await query.find();
                        
                        results.forEach(record => {
                            const data = record.toJSON();
                            const targetDay = days.value.find(d => d.dateStr === data.date);
                            if(targetDay && data.slots) {
                                targetDay.id = record.objectId;
                                Object.assign(targetDay.slots.s1, data.slots.s1);
                                Object.assign(targetDay.slots.s2, data.slots.s2);
                                Object.assign(targetDay.slots.s3, data.slots.s3);
                            }
                        });
                    } finally {
                        document.getElementById('loading-mask').style.display = 'none';
                        document.getElementById('app').style.display = 'block';
                    }
                };

                const login = () => {
                    if(!tempName.value) return alert('ËØ∑ËæìÂÖ•ÂßìÂêç');
                    currentUser.value = tempName.value;
                    localStorage.setItem('sjtu_user', tempName.value);
                };
                
                const logout = () => {
                    localStorage.removeItem('sjtu_user');
                    location.reload();
                };

                const bookAsMain = async (day, slot) => {
                    if(!currentUser.value) return alert('ËØ∑ÂÖàËÆæÁΩÆÂßìÂêç');

                    // Ê£ÄÊü•Áõ∏ÈÇªÊó∂ÊÆµ
                    const { s1, s2, s3 } = day.slots;
                    if (slot.id === 's1' && s2.booker === currentUser.value) return alert('‰∏çËÉΩËøûÁª≠È¢ÑÁ∫¶‰∏äÂçàÂíå‰∏ãÂçà‰∏§‰∏™Êó∂ÊÆµÂì¶ÔºÅ');
                    if (slot.id === 's2' && (s1.booker === currentUser.value || s3.booker === currentUser.value)) return alert('‰∏çËÉΩËøûÁª≠È¢ÑÁ∫¶Áõ∏ÈÇªÁöÑ‰∏§‰∏™Êó∂ÊÆµÂì¶ÔºÅ');
                    if (slot.id === 's3' && s2.booker === currentUser.value) return alert('‰∏çËÉΩËøûÁª≠È¢ÑÁ∫¶‰∏ãÂçàÂíåÊôö‰∏ä‰∏§‰∏™Êó∂ÊÆµÂì¶ÔºÅ');

                    if(slot.followers.includes(currentUser.value)) {
                        slot.followers = slot.followers.filter(n => n !== currentUser.value);
                    }
                    
                    slot.booker = currentUser.value;
                    saveToCloud(day);
                };

                const bookAsFollower = (day, slot) => {
                    if(!currentUser.value) return alert('ËØ∑ÂÖàËÆæÁΩÆÂßìÂêç');
                    if(slot.booker === currentUser.value) return alert('‰Ω†Â∑≤ÁªèÊòØËØ•Êó∂ÊÆµÁöÑÈ¢ÑÁ∫¶‰∫∫‰∫Ü');
                    if(slot.followers.includes(currentUser.value)) return;
                    
                    slot.followers.push(currentUser.value);
                    saveToCloud(day);
                };

                const cancelBooking = (day, slot, role) => {
                    if(!confirm('Á°ÆÂÆöË¶ÅÂèñÊ∂àÂêóÔºü')) return;
                    if(role === 'booker') {
                        slot.booker = null;
                    } else {
                        slot.followers = slot.followers.filter(n => n !== currentUser.value);
                    }
                    saveToCloud(day);
                };

                const saveToCloud = async (day) => {
                    try {
                        const dataToSave = {
                            slots: {
                                s1: { booker: day.slots.s1.booker, followers: day.slots.s1.followers },
                                s2: { booker: day.slots.s2.booker, followers: day.slots.s2.followers },
                                s3: { booker: day.slots.s3.booker, followers: day.slots.s3.followers }
                            }
                        };

                        if(day.id) {
                            const todo = AV.Object.createWithoutData('Booking', day.id);
                            todo.set('slots', dataToSave.slots);
                            await todo.save();
                        } else {
                            const Booking = AV.Object.extend('Booking');
                            const booking = new Booking();
                            booking.set('date', day.dateStr);
                            booking.set('slots', dataToSave.slots);
                            const res = await booking.save();
                            day.id = res.objectId;
                        }
                    } catch (error) {
                        console.error(error);
                        alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú');
                        fetchData();
                    }
                };
                
                const formatDate = (str) => {
                    const d = new Date(str);
                    const week = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'];
                    return `${d.getMonth()+1}.${d.getDate()} Âë®${week[d.getDay()]}`;
                };
                
                const getStatusText = (slot) => {
                    const isFull = slot.followers && slot.followers.length >= 3;
                    if (slot.booker && isFull) return 'Â∑≤Êª°Âëò';
                    if (!slot.booker && (!slot.followers || slot.followers.length === 0)) return 'Á©∫Èó≤';
                    if (!slot.booker && slot.followers.length > 0) return 'Áº∫È¢ÑÁ∫¶‰∫∫';
                    return 'ÂèØÂä†ÂÖ•';
                };
                
                const getStatusColor = (slot) => {
                    const status = getStatusText(slot);
                    if (status === 'Â∑≤Êª°Âëò') return 'bg-red-100 text-red-700';
                    if (status === 'Á©∫Èó≤') return 'bg-green-100 text-green-700';
                    if (status === 'Áº∫È¢ÑÁ∫¶‰∫∫') return 'bg-orange-100 text-orange-700';
                    return 'bg-blue-100 text-blue-700';
                };

                onMounted(() => {
                    initDays();
                    fetchData();
                });

                return { days, currentUser, tempName, login, logout, bookAsMain, bookAsFollower, cancelBooking, formatDate, getStatusText, getStatusColor };
            }
        });
        
        app.mount('#app');
    </script>
</body>
</html>
