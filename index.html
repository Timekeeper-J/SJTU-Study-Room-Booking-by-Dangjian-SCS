<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»„ç»‡éƒ¨è‡ªä¹ å®¤é¢„çº¦</title>
    <!-- å¼•å…¥ Tailwind CSS (ä¸ºäº†å¥½çœ‹) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Vue.js (ä¸ºäº†é€»è¾‘ç®€å•) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥ LeanCloud SDK (ä¸ºäº†å­˜æ•°æ®) -->
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <style>
        /* ç®€å•çš„è‹¹æœé£æ ¼å¾®è°ƒ */
        body { background-color: #F2F2F7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn { transition: all 0.2s; }
        .btn:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="app" class="max-w-md mx-auto p-4 pb-20">
        <header class="mb-6 mt-4">
            <h1 class="text-3xl font-bold text-gray-900">è‡ªä¹ å®¤é¢„çº¦ ğŸ“…</h1>
            <p class="text-gray-500 text-sm mt-1">ä½ å¥½ï¼Œ{{ currentUser || 'è¯·ç‚¹å‡»ä¸‹æ–¹è®¾ç½®å§“å' }}</p>
        </header>

        <!-- èº«ä»½è®¾ç½®åŒº -->
        <div v-if="!currentUser" class="mb-6 card p-4 bg-blue-50 border border-blue-100">
            <p class="text-sm text-blue-800 mb-2">é¦–æ¬¡ä½¿ç”¨è¯·è¾“å…¥ä½ çš„å§“åï¼š</p>
            <div class="flex gap-2">
                <input v-model="tempName" type="text" placeholder="ä¾‹ï¼šå¼ ä¸‰" class="border p-2 rounded flex-1">
                <button @click="login" class="bg-blue-600 text-white px-4 py-2 rounded font-medium btn">ç¡®å®š</button>
            </div>
        </div>

        <!-- æ—¥æœŸåˆ—è¡¨ -->
        <div class="space-y-4">
            <div v-for="day in days" :key="day.dateStr" class="card p-5 relative overflow-hidden">
                <!-- é¡¶éƒ¨æ—¥æœŸ -->
                <div class="flex justify-between items-baseline mb-3">
                    <h2 class="text-xl font-bold text-gray-800">{{ formatDate(day.dateStr) }}</h2>
                    <span :class="getStatusColor(day)" class="text-xs font-bold px-2 py-1 rounded-full bg-opacity-20">
                        {{ getStatusText(day) }}
                    </span>
                </div>

                <!-- é¢„çº¦è¯¦æƒ… -->
                <div class="space-y-3">
                    <!-- ä¸»é¢„çº¦äºº -->
                    <div class="flex items-center gap-2">
                        <span class="w-16 text-gray-500 text-sm">é¢„çº¦äºº</span>
                        <div v-if="day.booker" class="font-medium text-gray-900 bg-gray-100 px-2 py-1 rounded">
                            {{ day.booker }}
                            <span v-if="day.booker === currentUser" class="text-xs text-red-500 ml-1 cursor-pointer" @click="cancelBooking(day, 'booker')">(å–æ¶ˆ)</span>
                        </div>
                        <button v-else @click="bookAsMain(day)" :disabled="isFull(day)" class="text-blue-600 text-sm font-medium hover:bg-blue-50 px-2 py-1 rounded btn">
                            + æˆ‘æ¥é¢„çº¦
                        </button>
                    </div>

                    <!-- éšè¡Œäºº -->
                    <div class="flex items-start gap-2">
                        <span class="w-16 text-gray-500 text-sm mt-1">éšè¡Œ ({{day.followers ? day.followers.length : 0}}/3)</span>
                        <div class="flex-1 flex flex-wrap gap-2">
                            <span v-for="f in day.followers" :key="f" class="bg-gray-100 px-2 py-1 rounded text-sm text-gray-800">
                                {{ f }}
                                <span v-if="f === currentUser" class="text-xs text-red-500 ml-1 cursor-pointer" @click="cancelBooking(day, 'follower')">Ã—</span>
                            </span>
                            <button v-if="(!day.followers || day.followers.length < 3) && day.booker" 
                                    @click="bookAsFollower(day)" 
                                    class="text-blue-600 text-sm font-medium hover:bg-blue-50 px-2 py-1 rounded btn">
                                + åŠ å…¥
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-8 text-center text-gray-400 text-xs">
            ä¸Šæµ·äº¤å¤§è®¡ç®—æœºå­¦é™¢å…šå»ºç ”ç©¶ä¼šç»„ç»‡éƒ¨
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        // --- é…ç½®åŒºåŸŸ START ---
        // è¯·æ›¿æ¢ä¸ºä½ çš„ LeanCloud App ID å’Œ Key
        const APP_ID = 'MpWMjFVRc0H3Y5BAQuUk0DN7-gzGzoHsz'; 
        const APP_KEY = '6VXWHUYqbTjNVtqqnhmoJOzN';
        const SERVER_URL = 'https://avoscloud.com'; // å¦‚æœæ˜¯å›½é™…ç‰ˆä¸ç”¨æ”¹ï¼Œå›½å†…ç‰ˆéœ€å¡«ç»‘å®šåŸŸå(å¦‚æœæœ‰)æˆ–ä¿æŒé»˜è®¤è¯•ç”¨
        // --- é…ç½®åŒºåŸŸ END ---

        AV.init({ appId: APP_ID, appKey: APP_KEY, serverURLs: SERVER_URL });

        createApp({
            setup() {
                const days = ref([]);
                const currentUser = ref(localStorage.getItem('sjtu_user') || '');
                const tempName = ref('');

                // ç”Ÿæˆæœªæ¥7å¤©
                const initDays = () => {
                    const arr = [];
                    for(let i=0; i<7; i++) {
                        const d = new Date();
                        d.setDate(d.getDate() + i);
                        const dateStr = d.toISOString().split('T')[0];
                        arr.push({ dateStr, booker: null, followers: [] });
                    }
                    days.value = arr;
                };

                // ä» LeanCloud æ‹‰å–æ•°æ®
                const fetchData = async () => {
                    const query = new AV.Query('Booking');
                    query.greaterThanOrEqualTo('date', days.value[0].dateStr);
                    const results = await query.find();
                    
                    results.forEach(record => {
                        const data = record.toJSON();
                        const targetDay = days.value.find(d => d.dateStr === data.date);
                        if(targetDay) {
                            targetDay.id = record.objectId; // ä¿å­˜æ•°æ®åº“IDæ–¹ä¾¿æ›´æ–°
                            targetDay.booker = data.booker;
                            targetDay.followers = data.followers || [];
                        }
                    });
                };

                // ç™»å½•
                const login = () => {
                    if(!tempName.value) return alert('è¯·è¾“å…¥å§“å');
                    currentUser.value = tempName.value;
                    localStorage.setItem('sjtu_user', tempName.value);
                };

                // æˆä¸ºé¢„çº¦äºº
                const bookAsMain = async (day) => {
                    if(!currentUser.value) return alert('è¯·å…ˆè®¾ç½®å§“å');
                    
                    // è§„åˆ™ï¼šåŒä¸€ä¸ªäººä¸èƒ½è¿ç»­é¢„çº¦
                    // è·å–æ˜¨å¤©çš„æ—¥æœŸå­—ç¬¦ä¸²
                    const todayDate = new Date(day.dateStr);
                    const yestDate = new Date(todayDate);
                    yestDate.setDate(todayDate.getDate() - 1);
                    const yestStr = yestDate.toISOString().split('T')[0];
                    
                    // ç®€å•æŸ¥è¯¢å‰ä¸€å¤©çš„è®°å½• (å‰ç«¯ç®€å•æ ¡éªŒï¼Œé˜²å›å­ä¸é˜²å°äºº)
                    const prevQuery = new AV.Query('Booking');
                    prevQuery.equalTo('date', yestStr);
                    prevQuery.equalTo('booker', currentUser.value);
                    const prevRecord = await prevQuery.first();
                    
                    if(prevRecord) {
                        alert(`åŒå­¦ï¼Œæ ¹æ®è§„å®šï¼Œä½ å·²é¢„çº¦äº† ${yestStr}ï¼Œä¸èƒ½è¿ç»­ä¸¤å¤©æ‹…ä»»ä¸»é¢„çº¦äººå“¦ï¼`);
                        return;
                    }

                    saveToCloud(day, { booker: currentUser.value });
                };

                // æˆä¸ºéšè¡Œäºº
                const bookAsFollower = (day) => {
                    if(!currentUser.value) return alert('è¯·å…ˆè®¾ç½®å§“å');
                    if(day.followers && day.followers.includes(currentUser.value)) return;
                    if(day.booker === currentUser.value) return alert('ä½ å·²ç»æ˜¯é¢„çº¦äººäº†');
                    
                    const newFollowers = [...(day.followers || []), currentUser.value];
                    saveToCloud(day, { followers: newFollowers });
                };

                // å–æ¶ˆ
                const cancelBooking = (day, role) => {
                    if(!confirm('ç¡®å®šè¦å–æ¶ˆå—ï¼Ÿ')) return;
                    if(role === 'booker') {
                        saveToCloud(day, { booker: null, followers: [] }); // é¢„çº¦äººèµ°äº†ï¼Œéšè¡Œäººä¹Ÿæ¸…ç©º(è§„åˆ™å¯è‡ªå®š)
                    } else {
                        const newFollowers = day.followers.filter(n => n !== currentUser.value);
                        saveToCloud(day, { followers: newFollowers });
                    }
                };

                // ä¿å­˜åˆ° LeanCloud
                const saveToCloud = async (day, updates) => {
                    try {
                        // æœ¬åœ°ä¹è§‚æ›´æ–°ï¼ˆè®©ç•Œé¢å…ˆå˜ï¼Œæ˜¾å¾—å¿«ï¼‰
                        Object.assign(day, updates);

                        if(day.id) {
                            // æ›´æ–°ç°æœ‰è®°å½•
                            const todo = AV.Object.createWithoutData('Booking', day.id);
                            Object.keys(updates).forEach(k => todo.set(k, updates[k]));
                            await todo.save();
                        } else {
                            // æ–°å»ºè®°å½•
                            const Booking = AV.Object.extend('Booking');
                            const booking = new Booking();
                            booking.set('date', day.dateStr);
                            Object.keys(updates).forEach(k => booking.set(k, updates[k]));
                            const res = await booking.save();
                            day.id = res.objectId;
                        }
                    } catch (error) {
                        console.error(error);
                        alert('æ“ä½œå¤±è´¥ï¼Œå¯èƒ½æœ‰äººåˆšæŠ¢å…ˆäº†ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚');
                        fetchData(); // å¤±è´¥å›æ»š
                    }
                };

                // è¾…åŠ©å‡½æ•°
                const formatDate = (str) => {
                    const d = new Date(str);
                    const week = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                    return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ å‘¨${week[d.getDay()]}`;
                };
                const isFull = (day) => day.booker && day.followers && day.followers.length >= 3;
                const getStatusText = (day) => {
                    if (!day.booker) return 'å¯é¢„çº¦';
                    if (isFull(day)) return 'å·²æ»¡å‘˜';
                    return 'å¯åŠ å…¥';
                };
                const getStatusColor = (day) => {
                    if (!day.booker) return 'bg-green-100 text-green-700';
                    if (isFull(day)) return 'bg-red-100 text-red-700';
                    return 'bg-blue-100 text-blue-700';
                };

                onMounted(() => {
                    initDays();
                    fetchData();
                });

                return { days, currentUser, tempName, login, bookAsMain, bookAsFollower, cancelBooking, formatDate, isFull, getStatusText, getStatusColor };
            }
        });
        
        app.mount('#app');
    </script>
</body>
</html>